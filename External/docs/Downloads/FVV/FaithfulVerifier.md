# Faithful Verifier

The Faithful Verifier (FVV) is a commandline Linux utility that can be used to verify the "faithfulness" of an Amber token.  

**_NOTE:_** This utility and the Faithful Verification feature are available only to Premium subscriptions.

## Faithful Verification

A token is "faithful" when it is generated by authentic Amber services in attested Trusted Execution Environments (TEEs).  When Amber microservices that are involved in token generation start, they initialize TEE environments to contain attestation signing assets and other secrets.  All token generation processing occurs in these TEEs, and protected certificates and keys are released only to microservice instances that meet TEE quoting requirements.  In this way, the   Attestation information for each of these microservices is stored in a Faithful Verification ledger and referenced by every Amber token generated.

These ledger references in an Amber token can be used to validate the specific microservice isntances that produced that token and retrieve their TEE attestation information.  The FVV can both retrieve this attestation report, and independently validate the TEE quotes.  In this way an Amber user can audit the secure processing of Amber tokens.

**_NOTE:_** All Amber tokens have an expiration time, and the FVV process must be completed for a given Amber token before it expires.  This feature is intended for use with recently-created tokens, not historical audits.

## Downloading the Faithful Verifier

The Faithful Verifier is a downloadable executable found on the Amber Downloads page.

<Insert screenshots>

## Operating System Support

The Faithful Verifier is supported on Ubuntu 20.04.

## Prerequisites

The Faithful Verifier requires Intel® SGX DCAP (Intel® Software Guard Extensions (Intel® SGX) Data Center Attestation Primitives) for quote verification.  This means that DCAP must be installed on the system where the Faithful Verifier will run, and the system must also have access to the Intel® SGX PCCS (SGX Provisioning Certificate Caching Service) for SGX collaterals.

### Installing Intel® SGX DCAP Libraries

Add the Intel® SGX repository and install the DCAP library packages:

```bash
echo 'deb [arch=amd64] https://download.01.org/intel-sgx/sgx_repo/ubuntu focal main' > /etc/apt/sources.list.d/intel-sgx.list
wget -qO - https://download.01.org/intel-sgx/sgx_repo/ubuntu/intel-sgx-deb.key | apt-key add -
apt-get update
apt-get install -y libsgx-urts libsgx-dcap-quote-verify-dev libsgx-dcap-default-qpl
```
Edit `/etc/sgx_default_qcnl.conf` (pointing DCAP to use PCCS at https://api.trustedservices.intel.com/sgx/certification/v3/)

```json
{
  // *** ATTENTION : This file is in JSON format so the keys are case sensitive. Don't change them.
 
  //PCCS server address
  "pccs_url": "https://api.trustedservices.intel.com/sgx/certification/v3/",
 
  // To accept insecure HTTPS certificate, set this option to false
  "use_secure_cert": true,
 
...
```

## Retrieving a Faithful Verification Report

The Faithful Verifier requires an Amber attestation token to begin.  Save the Amber token to a file (ex. token.jwt) on the system where the Faithful Verifier will run.

<Link to workflow?>

Run the Faithful Verifier "report" function, providing an Amber API key for a tenant with a Premium subscription, and the Amber attestation token:

```bash
./faithful-verifier report -a <apikey> -t token.jwt
```

The Faithful Verifier will output the report to /root/fvreport.json

Sample report content:

```json
{
        "report": {
                "ledger": {
                        "93af5a99-5c0b-431b-b80d-2595ea2b9581": {
                                "service_id": "93af5a99-5c0b-431b-b80d-2595ea2b9581",
                                "semver": "",
                                "name": "quote-verification-service",
                                "quote": "AwACAAAAAAAIAA...",
                                "registration_date": "2022-09-23T21:08:18.989378Z"
                        },
                        "c4310ed7-5151-4d99-a852-5e5909461a2b": {
                                "service_id": "c4310ed7-5151-4d99-a852-5e5909461a2b",
                                "semver": "",
                                "name": "appraisal-service",
                                "quote": "AwACAAAAAA...",
                                "registration_date": "2022-09-23T21:07:40.823087Z"
                        }
                },
                "permit_list": {
                        "appraisal-service": {
                                "mrenclave": "wHakGNZvmutDn+WVlbzAQpHgQ4H5fi1w6iM3dMcl4yY=",
                                "mrsigner": "UCOMLt2H7JQc2ylutHW2mebKOoAjze76MNJJniarSJI=",
                                "semver": "v0.3.0-a26e2af"
                        },
                        "fv-controller": {
                                "mrenclave": "t4DKLyk/P5sWMfUL4lhcms2hPTUD5A00FusKTcUtcoM=",
                                "mrsigner": "uzDHNXi/1dDCTZnsM0u9SF27ywcOyNU9py/99Rvk1xU=",
                                "semver": "v0.1.0-b4be8fd"
                        },
                        "quote-verification-service": {
                                "mrenclave": "qjh7xfezNBD2o6H08rch1tyJJqPiv2JiqhkdkRMJcbA=",
                                "mrsigner": "AfDviFBqGfx1keF9gpOobaGjj7k/yL1WWb2QTaQEOEA=",
                                "semver": "v0.3.0-b4be8fd"
                        },
                        "tee-caching-service": {
                                "mrenclave": "PFrBenty/Yq0JqZ19WBvqpKld9uLIgLv5kcjGcLkhPk=",
                                "mrsigner": "XrRkpRLoHUQTS9zi9qQPv0/N/6g/got0C+2/k8/nhMY=",
                                "semver": "v0.3.0-6f63b26"
                        }
                },
                "date": "2022-09-26T17:30:58.019521Z",
                "nonce": "HUK..."
        },
        "user_data": "XXAYsYX90eyp1cjVCZNiGeEfzCQLnsJF6GV0Faw7r2s=",
        "report_quote": "AwACAAAAAAAIAA..."
}
```

### Report Details

The Faithful Verification Report contains multiple sections and data structures.  

#### Ledger

The Ledger section contains identifying information for each microservice instance that contributed to the generation of the reported Amber token.  

```json
"93af5a99-5c0b-431b-b80d-2595ea2b9581": {                           #Ledger entry ID
    "service_id": "93af5a99-5c0b-431b-b80d-2595ea2b9581",           #ID of the specific microservice instance
    "semver": "",                                                   #Build tag of the microservice image
    "name": "quote-verification-service",                           #Name of the microservice
    "quote": "AwACAAAAAAAIAA...",                                   #TEE (SGX) quote of the microservice instance used to register and request protected keys
    "registration_date": "2022-09-23T21:08:18.989378Z"              #Timestamp of registration
```

#### Permit List

The Permit List is a form of attestation policy that defines the list of specific microservices and their versions that are permitted to register and retrieve protected assets.  This includes the name and build tag of the microservice, and also SGX quote requirements including the "MRSIGNER" (the "Signing Identity" of the authority that signed the sealing key of the enclave) and the "MRENCLAVE" (the cryptographic hash of the enclave itself, different for each build).

The launch flow for "faithful" services includes requesting protected assets from a controller service, which will register and provide those assets only to microservice instances that meet the requirements specified in the Permit List.

```json
"appraisal-service": {                                              #Microservice Name
    "mrenclave": "wHakGNZvmutDn+WVlbzAQpHgQ4H5fi1w6iM3dMcl4yY=",    #MRENCLAVE value, cryptographic hash of the SGX enclave
    "mrsigner": "UCOMLt2H7JQc2ylutHW2mebKOoAjze76MNJJniarSJI=",     #MRSIGNER value, identity of the enclave signing authority
    "semver": "v0.3.0-a26e2af"                                      #Build tag of the microservice
```


#### User Data

The "user data" is a cumulative hash that includes, among other things, the json content of the report itself.  This is used to protect and verify the integrity of the report.

```json
"user_data": "XXAYsYX90eyp1cjVCZNiGeEfzCQLnsJF6GV0Faw7r2s=",
```

#### Report Quote

The report quote is the Intel SGX quote from the Faithful Verification controller that supplied the report.

<Is this accurate?>

```json
"report_quote": "AwACAAAAAAAIAA..."
```

## Verifying a Report

The Faithful Verifier can also be used to verify the facts asserted by the faithful verification report.  It does this by independently validating the SGX quotes for each of the quoted services using the Intel SGX DCAP libraries and the Intel SGX PCCS server - validating the quote itself, without using any Amber attestation resources.  In this way the "faithfulness" of the Amber token can be verified by a third party without relying only on Amber's assertion.  

**_NOTE_** The verify function requires the faithful verification report to be present in `/root/fvreport.json`

```bash
./faithful-verifier verify
```
Sample output:
```bash
Verification passed, results saved at: /root/faithfulservices.json
```
The content of the verification output will include comparisons of each faithful service against the permitlist as well as an independent verification that the service SGX quotes are valid.  If both of these facts are true, then the service will be reported as "faithful."

```json
{
        "93af5a99-5c0b-431b-b80d-2595ea2b9581": [
                "Service record quote for quote-verification-service with id: 93af5a99-5c0b-431b-b80d-2595ea2b9581 is valid",
                "quote-verification-service with id: 93af5a99-5c0b-431b-b80d-2595ea2b9581 passed verification against permitlist",
                "quote-verification-service with id: 93af5a99-5c0b-431b-b80d-2595ea2b9581 is faithful"
        ],
        "c4310ed7-5151-4d99-a852-5e5909461a2b": [
                "Service record quote for appraisal-service with id: c4310ed7-5151-4d99-a852-5e5909461a2b is valid",
                "appraisal-service with id: c4310ed7-5151-4d99-a852-5e5909461a2b passed verification against permitlist",
                "appraisal-service with id: c4310ed7-5151-4d99-a852-5e5909461a2b is faithful"
        ]
}
```


## Additional CLI details

```bash
Faithful Verifier CLI is used for getting and verifying amber faithful services

Usage:
  faithful-verifier [command]

Available Commands:
  completion  Generate the autocompletion script for the specified shell
  help        Help about any command
  report      Get report from amber faithful verification controller
  verify      Verifies the faithful verification report

Flags:
  -h, --help   help for faithful-verifier
```